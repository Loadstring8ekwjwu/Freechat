<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø´Ø§Øª Ø§Ù„Ø­Ø±ÙŠØ© Ø§Ù„Ù…ØªÙƒØ§Ù…Ù„</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { --main: #3ecf8e; --bg: #f0f2f5; --text: #333; }
        body { font-family: 'Segoe UI', Tahoma, sans-serif; background: var(--bg); margin: 0; color: var(--text); }
        
        /* Ø´Ø§Ø´Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ */
        #auth-screen { position: fixed; inset: 0; background: white; z-index: 1000; display: flex; align-items: center; justify-content: center; flex-direction: column; }
        .auth-box { width: 90%; max-width: 380px; padding: 30px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); text-align: center; }
        
        /* Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© */
        #main-app { display: none; height: 100vh; grid-template-columns: 300px 1fr; }
        .sidebar { background: white; border-left: 1px solid #ddd; display: flex; flex-direction: column; }
        .chat-area { display: flex; flex-direction: column; background: #e5ddd5; position: relative; }

        /* Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ ÙÙŠ Ø§Ù„Ø²Ø§ÙˆÙŠØ© */
        .profile-badge { position: fixed; top: 15px; left: 15px; background: var(--main); color: white; padding: 10px 18px; border-radius: 30px; cursor: pointer; font-weight: bold; z-index: 100; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }

        /* Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£ØµØ¯Ù‚Ø§Ø¡ */
        .friends-container { flex: 1; overflow-y: auto; padding: 15px; }
        .friend-card { padding: 15px; background: #f8f9fa; border-radius: 10px; margin-bottom: 10px; cursor: pointer; border: 1px solid transparent; transition: 0.2s; }
        .friend-card:hover { border-color: var(--main); background: #f0fff8; }

        /* Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ */
        .messages-list { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; }
        .message { padding: 10px 15px; border-radius: 15px; margin: 5px; max-width: 75%; font-size: 15px; line-height: 1.4; }
        .sent { background: #dcf8c6; align-self: flex-start; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
        .received { background: white; align-self: flex-end; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }

        /* Ø§Ù„Ù…Ø¯Ø®Ù„Ø§Øª */
        input { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; font-size: 16px; }
        button { width: 100%; padding: 12px; background: var(--main); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 16px; }
        button:disabled { background: #ccc; }

        /* Ø§Ù„Ù†ÙˆØ§ÙØ° Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø© (Modals) */
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.6); display: none; align-items: center; justify-content: center; z-index: 2000; }
        .modal-content { background: white; padding: 25px; border-radius: 15px; width: 320px; text-align: center; }

        @media (max-width: 700px) { #main-app { grid-template-columns: 1fr; } .sidebar { display: none; } }
    </style>
</head>
<body>

    <div id="auth-screen">
        <div class="auth-box">
            <h1 style="color: var(--main);">Ø´Ø§Øª Ø§Ù„Ø­Ø±ÙŠØ©</h1>
            <p>Ù…ÙˆÙ‚Ø¹ Ù„Ù„Ø¯Ø±Ø¯Ø´Ø© Ø§Ù„Ù…Ø¬Ø§Ù†ÙŠØ©. Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„Ùƒ Ù„Ù„Ø¨Ø¯Ø¡</p>
            <input type="email" id="auth-email" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ">
            <input type="password" id="auth-password" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± (6 Ø£Ø­Ø±Ù ÙØ£ÙƒØ«Ø±)">
            <button id="auth-submit-btn" onclick="handleAuth()">Ø¯Ø®ÙˆÙ„ / Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨</button>
            <p id="auth-status" style="font-size: 12px; color: #666; margin-top: 10px;"></p>
        </div>
    </div>

    <div class="profile-badge" id="profile-btn" style="display:none" onclick="openModal('profile-modal')">ğŸ‘¤ Ø­Ø³Ø§Ø¨ÙŠ</div>

    <div id="main-app">
        <div class="sidebar">
            <div style="padding: 20px; border-bottom: 1px solid #eee;">
                <h3 style="margin:0 0 15px 0">Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø§Øª</h3>
                <button onclick="openModal('add-friend-modal')">+ Ø¥Ø¶Ø§ÙØ© ØµØ¯ÙŠÙ‚ Ø¹Ø¨Ø± ID</button>
            </div>
            <div id="friends-list" class="friends-container">
                <div style="color:#888; text-align:center; margin-top:30px">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø£ØµØ¯Ù‚Ø§Ø¡ Ø¨Ø¹Ø¯</div>
            </div>
        </div>
        
        <div class="chat-area">
            <div id="chat-welcome" style="flex:1; display:flex; align-items:center; justify-content:center; flex-direction:column; color:#777">
                <h2>Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ ÙÙŠ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©</h2>
                <p>Ø§Ø®ØªØ± ØµØ¯ÙŠÙ‚Ø§Ù‹ Ø£Ùˆ Ø£Ø¶Ù Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯ Ø¹Ø¨Ø± Ø§Ù„Ù€ ID Ø§Ù„Ø®Ø§Øµ Ø¨Ù‡</p>
            </div>

            <div id="chat-box" style="display:none; flex:1; flex-direction:column; height: 100%;">
                <div id="chat-header" style="background:white; padding:15px; font-weight:bold; border-bottom:1px solid #ddd"></div>
                <div class="messages-list" id="messages-list"></div>
                <div style="padding:15px; background:white; display:flex; border-top:1px solid #ddd">
                    <input type="text" id="msg-input" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„ØªÙƒ..." style="margin:0 10px 0 0" onkeypress="if(event.key==='Enter') sendMessage()">
                    <button onclick="sendMessage()" style="width:100px">Ø¥Ø±Ø³Ø§Ù„</button>
                </div>
            </div>
        </div>
    </div>

    <div id="profile-modal" class="modal-overlay" onclick="closeModal(event)">
        <div class="modal-content">
            <h3>Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø³Ø§Ø¨</h3>
            <p style="font-size:14px; color:#666">Ø§Ù„Ù€ ID Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ (Ø´Ø§Ø±ÙƒÙ‡ Ù…Ø¹ Ø£ØµØ¯Ù‚Ø§Ø¦Ùƒ):</p>
            <div id="my-id-display" style="font-size:22px; font-weight:bold; color:var(--main); background:#f0fff8; padding:15px; border-radius:10px; border:2px dashed var(--main)">...</div>
            <button onclick="logout()" style="background:#ff4d4d; margin-top:20px">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
        </div>
    </div>

    <div id="add-friend-modal" class="modal-overlay" onclick="closeModal(event)">
        <div class="modal-content">
            <h3>Ø¨Ø¯Ø¡ Ù…Ø­Ø§Ø¯Ø«Ø© Ø¬Ø¯ÙŠØ¯Ø©</h3>
            <p style="font-size:14px; color:#666">Ø£Ø¯Ø®Ù„ ID Ø§Ù„Ø´Ø®Øµ Ø§Ù„Ø°ÙŠ ØªØ±ÙŠØ¯ Ù…Ø±Ø§Ø³Ù„ØªÙ‡:</p>
            <input type="text" id="target-id-input" placeholder="Ù…Ø«Ø§Ù„: ID-XXXXXX">
            <button onclick="addNewFriend()">Ø¥Ø¶Ø§ÙØ© ÙˆØ¨Ø¯Ø¡ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©</button>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://xrvkkhuukqxvuwscgcvh.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_FWznB9cBJHwv_yK0A3F79g_w7cCyNv-';
        const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        let myData = null;
        let activeChannel = null;
        let friendsList = [];

        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø§Ù„Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
        supabase.auth.onAuthStateChange((event, session) => {
            if (session) {
                initApp(session.user);
            } else {
                showAuthScreen();
            }
        });

        async function handleAuth() {
            const email = document.getElementById('auth-email').value.trim();
            const password = document.getElementById('auth-password').value.trim();
            const status = document.getElementById('auth-status');
            const btn = document.getElementById('auth-submit-btn');

            if (!email || password.length < 6) return alert("Ø£Ø¯Ø®Ù„ Ø¨ÙŠØ§Ù†Ø§Øª ØµØ­ÙŠØ­Ø©");

            btn.disabled = true;
            status.innerText = "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³ÙŠØ±ÙØ±...";

            // 1. Ù…Ø­Ø§ÙˆÙ„Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
            const { data, error: loginError } = await supabase.auth.signInWithPassword({ email, password });

            if (loginError) {
                status.innerText = "Ø¬Ø§Ø±ÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯...";
                // 2. Ø¥Ø°Ø§ Ù„Ù… ÙŠÙ†Ø¬Ø­ØŒ Ù†Ø­Ø§ÙˆÙ„ Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨
                const { error: signUpError } = await supabase.auth.signUp({ email, password });
                
                if (signUpError) {
                    alert("Ø®Ø·Ø£: " + signUpError.message);
                    btn.disabled = false;
                    status.innerText = "";
                } else {
                    alert("ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨Ùƒ! Ø§Ù„Ø¢Ù† Ø£Ø¯Ø®Ù„ Ø¨ÙŠØ§Ù†Ø§ØªÙƒ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰ Ù„Ù„Ø¯Ø®ÙˆÙ„.");
                    btn.disabled = false;
                }
            }
        }

        async function initApp(user) {
            document.getElementById('auth-screen').style.display = 'none';
            document.getElementById('main-app').style.display = 'grid';
            document.getElementById('profile-btn').style.display = 'block';

            // Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ Ù…Ù† SQL
            const { data, error } = await supabase.from('profiles').select('*').eq('id', user.id).single();
            
            if (data) {
                myData = data;
                document.getElementById('my-id-display').innerText = data.display_id;
            } else {
                console.error("Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù…Ù„Ù Ø´Ø®ØµÙŠØŒ Ù‡Ù„ Ù‚Ù…Øª Ø¨ØªØ´ØºÙŠÙ„ ÙƒÙˆØ¯ SQLØŸ");
            }
        }

        function addNewFriend() {
            const id = document.getElementById('target-id-input').value.trim().toUpperCase();
            if (id && id !== myData.display_id) {
                if (!friendsList.includes(id)) {
                    friendsList.push(id);
                    renderFriends();
                }
                closeAllModals();
                startChat(id);
            } else {
                alert("ID ØºÙŠØ± ØµØ§Ù„Ø­");
            }
        }

        function renderFriends() {
            const container = document.getElementById('friends-list');
            container.innerHTML = '';
            friendsList.forEach(id => {
                const div = document.createElement('div');
                div.className = 'friend-card';
                div.innerHTML = `<strong>ğŸ‘¤ ${id}</strong>`;
                div.onclick = () => startChat(id);
                container.appendChild(div);
            });
        }

        async function startChat(friendID) {
            if (activeChannel) activeChannel.unsubscribe();

            document.getElementById('chat-welcome').style.display = 'none';
            document.getElementById('chat-box').style.display = 'flex';
            document.getElementById('chat-header').innerText = "Ù…Ø­Ø§Ø¯Ø«Ø© Ù…Ø¹: " + friendID;
            document.getElementById('messages-list').innerHTML = '';

            // Ø¥Ù†Ø´Ø§Ø¡ Ù‚Ù†Ø§Ø© ÙØ±ÙŠØ¯Ø© Ù„Ù„Ø·Ø±ÙÙŠÙ†
            const roomID = [myData.display_id, friendID].sort().join('--');
            activeChannel = supabase.channel(roomID);

            activeChannel
                .on('broadcast', { event: 'shat_msg' }, (payload) => {
                    addMessageToUI(payload.payload.text, 'received');
                })
                .subscribe();
        }

        function sendMessage() {
            const input = document.getElementById('msg-input');
            const text = input.value.trim();
            if (text && activeChannel) {
                activeChannel.send({
                    type: 'broadcast',
                    event: 'shat_msg',
                    payload: { text: text }
                });
                addMessageToUI(text, 'sent');
                input.value = '';
            }
        }

        function addMessageToUI(text, type) {
            const list = document.getElementById('messages-list');
            const div = document.createElement('div');
            div.className = `message ${type}`;
            div.innerText = text;
            list.appendChild(div);
            list.scrollTop = list.scrollHeight;
        }

        // ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ù†ÙˆØ§ÙØ°
        function openModal(id) { document.getElementById(id).style.display = 'flex'; }
        function closeAllModals() { document.querySelectorAll('.modal-overlay').forEach(m => m.style.display = 'none'); }
        function closeModal(e) { if(e.target.classList.contains('modal-overlay')) closeAllModals(); }
        async function logout() { await supabase.auth.signOut(); location.reload(); }
        function showAuthScreen() { document.getElementById('auth-screen').style.display = 'flex'; }
    </script>
</body>
</html>
