<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>اختبار شات الحرية</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: sans-serif; text-align: center; padding: 20px; background: #f0f2f5; }
        .card { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); max-width: 400px; margin: auto; }
        input { width: 90%; padding: 10px; margin: 10px 0; border: 1px solid #ddd; border-radius: 5px; }
        button { width: 95%; padding: 12px; background: #3ecf8e; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; margin-bottom: 10px; }
        #log { background: #333; color: #0f0; padding: 10px; border-radius: 5px; text-align: left; font-size: 12px; height: 150px; overflow-y: auto; margin-top: 20px; direction: ltr; }
    </style>
</head>
<body>

    <div class="card">
        <h2>اختبار الاتصال</h2>
        <input type="email" id="email" placeholder="الايميل">
        <input type="password" id="password" placeholder="الباسورد">
        
        <button onclick="testConnection()">1. اختبار الاتصال بالسيرفر</button>
        <button onclick="handleAuth()" style="background: #1877f2;">2. محاولة الدخول / التسجيل</button>
        
        <div id="log">-- سجل الأحداث (Logs) --</div>
    </div>

    <script>
        const SUPABASE_URL = 'https://xrvkkhuukqxvuwscgcvh.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_FWznB9cBJHwv_yK0A3F79g_w7cCyNv-';
        const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        function logger(msg, isError = false) {
            const logDiv = document.getElementById('log');
            logDiv.innerHTML += `<div style="color:${isError ? 'red' : '#0f0'}">> ${msg}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        async function testConnection() {
            logger("جاري اختبار الاتصال برابط Supabase...");
            try {
                const res = await fetch(SUPABASE_URL);
                logger("السيرفر يستجيب بنجاح!");
            } catch (e) {
                logger("فشل الاتصال بالسيرفر: " + e.message, true);
            }
        }

        async function handleAuth() {
            const email = document.getElementById('email').value.trim();
            const password = document.getElementById('password').value.trim();

            if (!email || !password) return alert("اكتب الايميل والباسورد");

            logger(`محاولة الدخول بـ: ${email}`);

            try {
                const { data, error } = await supabase.auth.signInWithPassword({ email, password });

                if (error) {
                    logger("خطأ دخول: " + error.message + ". جاري محاولة إنشاء حساب...");
                    const { data: sData, error: sError } = await supabase.auth.signUp({ email, password });
                    
                    if (sError) {
                        logger("فشل إنشاء الحساب: " + sError.message, true);
                        alert("فشل نهائي: " + sError.message);
                    } else {
                        logger("تم إنشاء الحساب بنجاح! جرب الدخول الآن.");
                        alert("تم إنشاء الحساب! اضغط دخول مرة أخرى");
                    }
                } else {
                    logger("نجح الدخول! جاري توجيهك...");
                    alert("نجح الدخول! الـ ID الخاص بك سيظهر الآن");
                    // هنا نضع كود إظهار الـ ID
                    showID(data.user.id);
                }
            } catch (err) {
                logger("خطأ غير متوقع: " + err.message, true);
            }
        }

        async function showID(uid) {
            const { data, error } = await supabase.from('profiles').select('display_id').eq('id', uid).single();
            if (data) {
                alert("الـ ID الخاص بك هو: " + data.display_id);
            } else {
                logger("فشل جلب الـ ID. تأكد من تشغيل كود SQL وتفعيل الـ Realtime", true);
            }
        }
    </script>
</body>
</html>
